<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous">
</script>
<script src="https://kit.fontawesome.com/a123c97772.js"></script>

<div class="passthrough_info" id="init_config" style="display:none">
~!@#$PASSTHROUGH~!@#$
</div>

<html>
<head><title>Edit Configuration</title></head>
<body>

  <div id="message" style="color:red">LOADING CONFIG...</div>
  Test Config Page

  <h4>WIFI Status: <span id="WIFIstatus"></span></h4>

    <input type="hidden" id="mode" value="updatecfg">
    <input type="hidden" id="configsecret" value="defaulterd">
    Node Name:
    <input type="text" id="NODENAME"><br>

    WIFI SSID:
    <input type="text" id="WIFISSID"><br>

    WIFI PW:
    <input type="text" id="WIFIPW"><br>

    NODE DESCRIPTION:
    <input type="text" id="NODEDESC"><br>

    IOS RESOURCES:
    <input type="text" id="IOSRESOURCES"><br>

    PASSWORD:
    <input type="text" id="PASSWORD"><br>

    <input type="button" value="UPDATE CONFIG" onclick="sendNewConfig()">
    </form>

    <hr />




    Number of Channels:
    <input type="number" id="numCH" min="1" max="128" />
    <h2>Channel Definitions:</h2>
    <div id='chdefinitions'>

    </div>


    !!GO HERE!!


    <input type="submit">
  </form>
</body>
</html>
<script type="text/javascript">
    configData="";

    //configEndpoint="/CFG";
    configEndpoint="http://192.168.1.1/CFG";

    function initConfigPage(){
        //get configuration from ESP
        ajax=$.get(configEndpoint+"?getConfig");

        //fail condition, ask for help
        ajax.fail(function(data){
            $('#message').html("UNABLE TO RETRIEVE CONFIGURATION");
        });

        //message recieved, assume it's correctly formatted
        ajax.done(function(data){
            //clear load message
            $('#message').html("");

            //parse into JSON
            configData=JSON.parse(data).ESPconfig;

            //log recieved JSON
            console.log("recieved config data",data);
            if(configData.WIFISTATUS){
              if (configData.WIFISTATUS=="0"){
                $('#WIFIstatus').html("Not Connected");
              }
              else if (configData.WIFISTATUS=="1"){
                $('#WIFIstatus').html("Connected to "+configData.WIFISSID);
              }

              //fill out all the form fields
              $('#WIFISSID').val(configData.WIFISSID);
              $('#WIFIPW').val(configData.WIFIPW);
              $('#NODENAME').val(configData.NODENAME);
              $('#NODEDESC').val(configData.NODEDESC);
              $('#IOSRESOURCES').val(configData.IOSRESOURCES);



            }
            //there is something wrong with this JSON
            else{
              $('#message').html("CONFIGURATION MALFORMED. SET NEW CONFIGURATION");
            }

            //check WIFI status

            
            
        });

    }
    function sendNewConfig(){
       configDict={};
       configDict['ESPconfig']={}
       configDict['ESPconfig']['WIFISSID']=$('#WIFISSID').val();
       configDict['ESPconfig']['WIFIPW']=$('#WIFIPW').val();
       configDict['ESPconfig']['NODENAME']=$('#NODENAME').val();
       configDict['ESPconfig']['NODEDESC']=$('#NODEDESC').val();

      ajax = $.ajax(
      {
        url: configEndpoint,
        type: "POST",
        data: JSON.stringify(configDict)
      });

      ajax.done(function(data){
        console.log("dict sent",configDict);
        $('#message').html("NEED TO RELOAD");
      });

      ajax.fail(function(data){
        console.log("dict send fail",configDict);
        $('#message').html("SEND FAILED");
      });

    }




    console.log("loading page");
    initConfigPage();
    console.log("LOAD END");

</script>
